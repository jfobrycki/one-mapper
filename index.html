<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!--This started with the tempate from module 6 and then modified-->
  <title>One Mapper</title>

  <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.3.1/cerulean/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-C++cugH8+Uf86JbNOnQoBweHHAe/wVKN/mb0lTybu/NZ9sEYbd+BbbYtNpWYAsNP" crossorigin="anonymous">
  <!--Loading in the fonts that I want to use-->
  <link href="https://fonts.googleapis.com/css?family=Oswald:400" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Overpass:400" rel="stylesheet">
  <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet" />

  <style>
    #map {
      width: 100%;
      height: 40vh;
    }

    #about {
      max-height: 80vh;
      overflow-y: scroll;
    }

    /*Setting some additional CSS rules*/
    .h1 {
      font-family: 'Oswald';
      font-weight: 400;
    }

    .list {
      font-family: 'Oswald';
      font-weight: 400;
      font-size: x-large;
    }

    .descriptivetext {
      font-family: 'Overpass';
      font-weight: 400;
      color: black
    }

    .links {
      color: blue
    }

    /*Throughout the document, I'm annotating with some references for code*/
    /*https://www.w3schools.com/css/css3_buttons.asp*/
    .button1 {
      background-color: lightgray;
      /* Green */
      border: none;
      color: white;
      width: 180px;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
    }

    .button2 {
      background-color: #2b8cbe;
      border: none;
      color: white;
      width: 180px;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
    }

    .button3 {
      background-color: #1c9099;
      border: none;
      color: white;
      width: 110px;
      padding: 10px 10px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
    }

    #legend {
      line-height: 18px;
      color: #000000;
      background-color: white;
      font-size: 20px;
      /* width: 150px; */
      /* height: 200px; */
      padding: 10px;
      display: none;
    }

    #legend span {
      /* width: 150px; */
      height: 25px;
      float: left;
      /* margin-right: 4px; */
      /* margin-bottom: 4px; */
      margin: 4px;
      padding: 4px;
      opacity: 0.7;
    }

    #popup {
      display: none
    }

    /* Small devices (landscape phones, 576px and up) */
    @media (min-width: 576px) {}

    /* Medium devices (tablets, 768px and up) */
    @media (min-width: 768px) {
      #map {
        height: 60vh;
      }
    }

    /* Large devices (desktops, 992px and up) */
    @media (min-width: 992px) {

      #map {
        height: 80vh;
      }
    }

    /* Extra large devices (large desktops, 1200px and up) */
    @media (min-width: 1200px) {}
  </style>

  <!--Loading in leaflet, jquery, and others-->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.min.js"></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
  <script src='https://unpkg.com/simple-statistics@7.1.0/dist/simple-statistics.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
    </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
    </script>
  <script src="https://d3js.org/d3.v5.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>
  <script>L_PREFER_CANVAS = true</script>
  <script src='https://unpkg.com/leaflet-image@latest/leaflet-image.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.2.61/jspdf.debug.js"></script>


</head>

<body>

  <!--Setting the text on the right side of the page-->
  <div class="container-fluid">
    <header class="row py-3 bg-dark text-white">
      <div class="col mx-2">
        <h1 class="h1"><span class='MyMapName'>One Mapper v0.1</span></h1>
        <h4 class="h5"><span class='OneMapperVersion'></span></h5>
      </div>
    </header>

    <section class="row bg-secondary">
      <div class="col-12 col-md-7 col-lg-8 px-0">
        <div id="map" class="bg-light position-relative"></div>
      </div>

      <aside id="about" class="col-12 col-md-5 col-lg-4 text-dark py-2">
        <section>
          <h2 class="h2 text-dark">Single Variable Mapping</h2>
          <p class="descriptivetext">Visualize data by location and split into four value ranges by uploading data or clicking on the map
            (<a href="https://github.com/jfobrycki/one-mapper" target="_blank" class="links">Tutorial</a>). If you need to clear the map, click this button.</p>
          <!--The tutorial link can go to a pdf or a GitHub page? Maybe GitHubt page that includes an online or pdf option for descriptions-->
          <!--https://stackoverflow.com/questions/29884654/button-that-refreshes-the-page-on-click-->
          <button type="button" class="button3" id="reload" onclick="window.location.href=window.location.href">Clear Map!</button>
          <br><br>
          <h5 class="descriptivetext">Where do you want to map?</h5>
          <p class="descriptivetext">Navigate with the dropdown or by clicking/zooming. On data upload, map will
            automatically zoom to your points.</p>
          <!--Idea here would be for a button to activate the popup window rather than having the popup appear right away, it could be more difficult for users to navigate if the popup keeps appearing first-->
          <!--This is the dropdown to select which continent is of interest-->
          <div class="form-group mr-3 mt-3" id="dropdown-ui">
            <select class="form-control bg-primary text-white">
              <option value="Global" selected>Global</option>
              <option value="Africa">Africa</option>
              <option value="Europe">Europe</option>
              <option value="North America">North America</option>
              <option value="South America">South America</option>
              <option value="Asia">Asia</option>
              <option value="Australia">Australia</option>
              <option value="Antarctica">Antarctica</option>
            </select>
          </div>
          <!-- <h5 class="descriptivetext">Please enter a short title for your map</h5> -->
          <br>
          <h5 class="descriptivetext">What do you want to map?</h5>
          <form action="" class="descriptivetext">
            <label for="fname">Short title/description:</label>
            <input type="text" id="tname" name="tname" value="My New Map!"><br>
            <!--<input type="submit" value="Submit">-->
            <!--At some point, the text the user enters for the short title/description would then be pulled into the "Print It" part of the map-->
          </form>
          <!--<h5 class="descriptivetext">Which variable are you mapping?</h5>-->
          <form action="" class="descriptivetext">
            <label for="fname">Variable name:</label>
            <input type="text" id="vname" name="vname" value="Name"><br><br>
            <!--<input type="submit" value="Submit">-->
            <!--At some point, the text the user enters for the short title/description would then be pulled into the "Print It" part of the map-->
          </form>
          <h5 class="descriptivetext"><b>Existing dataset?</b> Upload using the link</h5>
          <i>Your csv should have three columns: Lat, Lon, and Value. Download a <a href="https://github.com/jfobrycki/one-mapper#Tutorial-and-example-files" target="_blank">template dataset</a>.</i>
          <p><input type="file" id="fileUpload" /></p>
          <!--https://www.w3schools.com/tags/tag_input.asp-->
          <h5 class="descriptivetext">After loading in <span class='TotalVar'></span> points, now visualize by quartile!
          </h5>
          <button type="button" class="button2" id="mapit">Map Values!</button>
          <br><br><br>
          <h5 class="descriptivetext"><b>Creating data?</b> Click the button below and then generate a map!</h5>
          <p class="descriptivetext">
            <!--https://www.d3-graph-gallery.com/graph/interactivity_button.html-->
            <!--https://www.w3schools.com/jsref/event_onclick.asp-->
            <!--The actual button interactivity is below in the script portion of the document-->
            <button type="button" class="button1" id="addpoints">Add Points</button>

            <!-- ---- -->
          <div id='popup' class="p-2">
            <span></span>
            <label for="fname">Value:</label>
            <input type="text" id="fname" name="fname">
            <button id='save'>Save</button>
            <button id='del'>Delete</button>
          </div>
          <!-- ---- -->
          </p>
          <h5 class="descriptivetext">After creating <span class='TotalAdd'></span> points, now visualize by quartile!
          </h5>
          <p>
            <button type="button" class="button2" id="genmap">Generate Map!</button>
          </p>
          <hr>
          <h5 class="descriptivetext">Other Mapping Resources</h5>
          <!--Including additional links and suggestions. One Mapper doesn't do everything, in fact, it does one task and many people may be interested in other tasks. Those are best accomplished with other mapping resources-->
          <ul>
            <li>The framework for this page was inspired by <a href="http://geojson.io/" target="_blank">geojson.io</a>
            </li>
            <li>Map documentation is provided on the <a href="" target="_blank">GitHub page</a></li>
            <li>Interested in more advanced mapping?</li>
            <ol><a href="https://geodacenter.github.io/index.html" target="_blank">GeoDa</a></ol>
            <ol><a href="https://qgis.org/en/site/QGIS" target="_blank">QGIS</a></ol>
            <ol><a href="https://desktop.arcgis.com/en/arcmap/" target="_blank">ESRI ArcGIS</a></ol>
            <ol><a href="https://cengel.github.io/rspatial/" target="_blank">Spatial analysis in R</a>
              <ol>(many R options, here's one example)</ol>
            </ol>
          </ul>

          <!--Put the footer within the right side pane-->
          <!--Shifted down the section and aside tags to move this within the right side pane-->
          <footer class="row bg-dark text-white py-3">
            <div class="col m-2">
              <ul class="list" style="list-style-type:none;">
                <!--https://www.w3schools.com/html/tryit.asp?filename=tryhtml_lists_unordered_none-->
                <li>John F Obrycki, New Maps Plus</li>
                <li>GitHub <a href="https://jfobrycki.github.io/" target="_blank">Project Page</a> and all <a href="https://github.com/jfobrycki" target="_blank">repositories</a> and  | <a href="https://www.linkedin.com/in/john-f-obrycki-1a3b032b">LinkedIn</a></li>
              </ul>
            </div>
          </footer>
  </div> <!-- end .container-fluid -->

  </section>
  </aside>
  </section>

  <!-- legend is outside of container-fluid and will be dynamically added to map -->
  <div class="bg-white py-2 px-3 ml-3 mt-3" id="legend"></div>

  <script>
    //////////////////////////////SET THE BASEMAPS
    // Setting the global options for the map

    var options = {
      center: [0, 0],
      zoom: 2,
      minZoom: 2,
      maxZoom: 18,
      zoomSnap: 0.25,
      zoomControl: true
    }

    // This approach is based on the https://leafletjs.com/examples/layers-control/
    // There may be other options that condense this code
    // The var names can be tricky to keep separate and to keep thinking of unique terms

    // This sets the links to the three basemaps
    var SatelliteImagery = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
    var OpenTopoMap = 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png';
    var OpenStreetBase = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    // More options available here
    // http://leaflet-extras.github.io/leaflet-providers/preview/index.html

    // Get basemap attributes from Leaflet Providers for the specific map used
    var basemap_attributes = 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community';
    var OpenTopo_attributes = 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)';
    var OpenStreet_attributes = '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>';

    //Now let's set the tileLayers
    //Why is zoomOffset = -1 necesary to keep the map centered at the [0,0] point? If I remove zoomOffset, then the map shifts to the north
    var SatBase = L.tileLayer(SatelliteImagery, { id: 'satellite', tileSize: 512, zoomOffset: -1, attribution: basemap_attributes });
    var TopoBase = L.tileLayer(OpenTopoMap, { id: 'topo', tileSize: 512, zoomOffset: -1, attribution: OpenTopo_attributes });
    var StreetBase = L.tileLayer(OpenStreetBase, { id: 'OSM', tileSize: 512, zoomOffset: -1, attribution: OpenStreet_attributes });
    // requests some map tiles

    //Create the map with the options from above
    //Set the Satellite to be the default layer
    var map = L.map('map', options, {
      layers: [SatBase]
    });

    //Create an object with the three baselayers
    var baseLayers = {
      "Satellite": SatBase,
      "Streets": StreetBase,
      "Topo": TopoBase
    };

    //Get the Satellite basemap loaded first
    var tiles = SatBase.addTo(map);

    //Then add the other layers in the control and keep the control visible (don't collapse)
    L.control.layers(baseLayers, null, { collapsed: false }).addTo(map);
    //////////////////////////////END OF SET THE BASEMAPS




    //////////////////////////////ZOOMING AROUND THE MAP
    //The lat lon mentioned in the zoomAreas const are just from clicking on the map itself
    const zoomAreas = {
      "Global": [0, 0],
      "Africa": [5.4026, 21.7548],
      "Europe": [52.4856, 29.8129],
      "North America": [42.5433, -98.1069],
      "South America": [-17.2498, -59.9709],
      "Asia": [44.3322, 91.6642],
      "Australia": [-25.5977, 134.1274],
      "Antarctica": [-85.2539, -2.167]
    }
    //When the global option is selected, zoom at 2, but for all others, zoom into the map a little
    var zoom1 = 3.5;
    var zoom2 = 2;

    //trying to set the zoom depending on global (zoom out) versus any continent, then zoom in more
    $('#dropdown-ui select').change(function () {
      if (this.value == "Global") {
        map.setView(zoomAreas[this.value], zoom2)
      } else {
        //map.panTo(zoomAreas[this.value],zoom)
        map.setView(zoomAreas[this.value], zoom1)
      }
    });
    ////////////////////////////////END OF ZOOMING AROUND THE MAP




    ///////////////////////////////////////////////SETTING EVENT HANDLERS
    //Boyd suggested this file upload approach
    document.querySelector('#fileUpload').addEventListener('change', event => {
      handleUpload(event)
    })
    ///////////////////////////////////////////////END OF SETTING EVENT HANDLERS


    /////////////////////////////////////////////////////////////////////////
    ////////////////CODE FOR UPLOADING DATA AND VISUALIZING ON MAP////////////
    /////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////


    ////////////////////////////////////////////LOAD IN THE DATA
    function handleUpload(event) {
      const file = document.querySelector('#fileUpload').files[0];
      Papa.parse(file, {
        complete: function (results) {
          console.log(results.data);
          // Thanks for all your help Boyd!!!!

          //create the geojsonFeature placeholder
          var geojsonFeature = []

          //create the loop, note that var starts with 1 because the first row is the names Lat, Lon, Value
          for (var i = 1; i < results.data.length; i++) {

            //push the results of the loop to geojsonFeature
            geojsonFeature.push(

              //this is the structure of an geojson
              //for example, https://leafletjs.com/examples/geojson/
              {
                "type": "Feature",
                "geometry": {
                  "type": "Point",
                  //first we collect the latitude, then the longitude, these are items 0 and 1 
                  //structure of the coordinates is x , y or longitude, latitude
                  "coordinates": [results.data[i][1], results.data[i][0]]
                },
                "properties": {
                  //item 2 in the same row is the value, what we want to plot
                  "value": [results.data[i][2]]
                }
              } //this is the end of the geojsonFeature
            ) //this is the end of the push command
          } //end of the for loop

          //Get the number of items in the geojsonFeature and update right panel
          $(".TotalVar").html((geojsonFeature.length).toLocaleString());

          //pass the new geojsonFeature to the updateMap function
          updateMap(geojsonFeature)

        } //end of complete function(results)
      });

      // var reader = new FileReader();
      // reader.onload = onReaderLoad();
      // reader.readAsText(event.target.files[0]);

    } //this is the end of the handleUpload function
    ///////////////////////////////////////////////END OF LOAD IN THE DATA




    ////////////////////////////////////////////////PUT THE VALUES ON THE MAP

    //and pull in this function
    function updateMap(geojsonFeature) {
      //check that it's routing correctly
      console.log(geojsonFeature)
      console.log(geojsonFeature[1].properties.value[0])
      var mapops = {
        "opacity": 1,
        "weight": 1,
        "radius": 5,
        "fillOpacity": 0.6,
        "color": 'black',
        "fillColor": 'black'
      };


      for (var i = 0; i < geojsonFeature.length; i++) {
        var popup = `<b>Value:</b> ${geojsonFeature[i].properties.value[0]}</h3>`
        //console.log(popup)

      } //end of the for loop

      const NewMapData = L.geoJSON(geojsonFeature, {
        // style counties with initial default path options
        onEachFeature: function (feature, layer) {
          layer.bindPopup(`<b>Value:</b> ${feature.properties.value}</h3>`)
        },
        pointToLayer: function (feature, latlng) {
          return L.circleMarker(latlng, mapops)
        },
      }).addTo(map)

      //get the boundaries
      map.fitBounds(NewMapData.getBounds());

      // adjust zoom level of map
      map.setZoom(map.getZoom() - .4);

      //pass to updateLegend function
      updateLegend(NewMapData)

    } //end of updateMap

    ////////////////////////////////////////////////END OF PUT THE VALUES ON THE MAP



    //////////////////////////////BUTTON FUNCTIONALITY: MAPIT - with uploaded data
    //testing out some button functionality
    //https://www.w3schools.com/jsref/tryit.asp?filename=tryjsref_onclick_dom
    //https://stackoverflow.com/questions/18388288/how-do-you-add-marker-to-map-using-leaflet-map-onclick-function-event-handl
    //may be a jquery .one() approach for having a function work just once

    function addLegend() {
      var legend = L.control({ position: 'bottomleft' });

      legend.onAdd = function (map) {
        var div = L.DomUtil.get('legend')
        return div
      }

      legend.addTo(map); //add the legend to the map
    }

    addLegend()

    function updateLegend(NewMapData) {
      document.getElementById("mapit").addEventListener("click", function () {
        console.log(NewMapData);
        var totalvalues = console.log(Object.keys(NewMapData).length + 1);
        getClassBreaks(NewMapData)

        const breaks = getClassBreaks(NewMapData);

        NewMapData.eachLayer(function (layer) {
          // console.log(breaks)
          console.log(layer.feature.properties.value[0]);
          layer.setStyle({
            fillColor: getColor2(layer.feature.properties.value[0], breaks),
            fillOpacity: 1
            // fillColor: getColor2(breaks)
          })
        });

        $(".MyMapName").html(document.getElementById("tname").value);
        $(".OneMapperVersion").html("Made with OneMapper v0.1");
        //zoom out slightly to make space for the legend
        map.setZoom(map.getZoom() - .55);

        // Setting up the legend

            grades = [0, 25, 50, 75, 100],
            labels = [];

          const div = document.querySelector('#legend')
          div.style.display = 'block'

          div.innerHTML = `<b>Legend</b><br><br>`
          console.log(document.getElementById("vname").value)
          div.innerHTML += document.getElementById("vname").value
          div.innerHTML += `<br><br>`
          // loop through the Array of classification break values
          for (let i = 0; i <= breaks.length - 1; i++) {
            let color = getColor2(breaks[i][0], breaks);
            console.log(color)

            // For large numbers, test for how large you want and convert to exponential notation
            // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/toExponential

            function expo(x, f) {
              return Number.parseFloat(x).toExponential(f);
            }

            console.log(expo(123456, 2));
            // expected output: "1.23e+5"

            div.innerHTML += (
              `<span style="background:${color}">
              <label>${(breaks[i][0]).toLocaleString()} &mdash;
              ${(breaks[i][1]).toLocaleString()}</label></span><br>`);
          }

        //closes the legend.onAdd function
        //https://www.geeksforgeeks.org/how-to-get-the-value-of-text-input-field-using-javascript/

        // AddPointButton(NewMapData)
        //Here I will add code to show the title to the map

      }) //closes the button portion
    } //end of updateLegend function


    // function AddPointButton(NewMapData){
    toggle = false;
    document.getElementById("addpoints").addEventListener("click", function () {
      toggle = !toggle;
      this.style.backgroundColor = toggle ? "#4CAF50" : "lightgray";
      console.log(this.style.backgroundColor);
      console.log(this.style.backgroundColor == 'lightgray');
      console.log(this.style.backgroundColor == "rgb(76, 175, 80)")
      // var buttoncolor = document.getElementById("addpoints");
      //  var curColor = window.getComputedStyle(buttoncolor,null).color;
      //  console.log(curColor);
      // if (curColor =! "lightgray") {
      if (this.style.backgroundColor == "rgb(76, 175, 80)") {
        onMapClick(); // pass data to update
        // the line below displays the popup on the right panel of the page
        //   document.querySelector('#popup').style.display = 'inherit'

      } else {
        document.querySelector('#popup').style.display = 'none'
        doubleClickZoom();
        //window.stop(onMapClick);

      }

    }); 


    function getClassBreaks(NewMapData) {
          // 				// create empty Array for storing values
          const alldata = [];
          // 				// loop through all the counties
          NewMapData.eachLayer(function (layer) {
            let values = Number(layer.feature.properties.value);
            alldata.push(values); // push the normalized value for each layer into the Array
          });
          // 				// determine similar clusters
          const clusters = ss.ckmeans(alldata, 4);
          //const clusters = ss.equalIntervalBreaks(alldata, 4);
          console.log(clusters)
          // 				// create an array of the lowest value within each cluster
          const breaks = clusters.map(function (cluster) {
            return [cluster[0], cluster.pop()];
          });
          // 				//return array of arrays, e.g., [[0.24,0.25], [0.26, 0.37], etc]
          return breaks;
        } //this is the end of the getClassBreaks function

        function getColor2(d, breaks) {
          // 				// function accepts a single normalized data attribute value
          // 				// and uses a series of conditional statements to determine which
          // 				// which color value to return to return to the function caller
          // 				// we defined breaks as a const, so it is a standard reference that can't be changed

          if (d <= breaks[0][1]) {
            return '#fef0d9';
          } else if (d <= breaks[1][1]) {
            return '#fdcc8a';
          } else if (d <= breaks[2][1]) {
            return '#fc8d59';
          } else if (d <= breaks[3][1]) {
            return '#d7301f'
          }
        } //this is the end of the getColor function

      
        
        
        

    




    // }
    //})
    //////////////////////////////END OF BUTTON FUNCTIONALITY: MAPIT


    /////////////////////////////////////////////////////////////////////////
    ////////////////END OF CODE FOR UPLOADING DATA AND VISUALIZING ON MAP/////
    /////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////



    /////////////////////////////////////////////////////////////////////////
    //////CODE FOR USER CLICKING ON MAP, CREATING POINTS, AND VISUALIZING/////
    /////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////


    ///////////////////////////////ADD POINTS FUNCTIONALITY////////////////

    //part one: click the add points button to activate a function
    //part two: now that the function is activated, when the user clicks on the map, the popup with lat lon and value appears
    //user has the option to save or delete this new point
    //part three: if user clicks save, then the point is pushed to an array
    //part four: if user clicks delete, then the point is removed from the array
    //part five: if a person clicks a following button, map it, then the quartiles are calculated and the map reloads
    //summary: the add points button acts as a gatekeeper for all of this subsequent functionality

    //https://leafletjs.com/examples/quick-start/
    //Let's create a popup

    //https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/color
    //https://stackoverflow.com/questions/45259626/switch-background-color-of-a-div-between-2-colors-on-alternate-clicks
    //https://stackoverflow.com/questions/33447118/javascript-if-else-style-changing


    //https://leafletjs.com/reference-1.6.0.html

    //Here's a function that would pull up an information panel when the map is clicked
    //A user could then enter data, though right now it's a static popup
    //Some type of event handler, maybe a .onclick function?
    //Some kind of event handler that checks if another button is selected, and then has the pop up appear

    // const NewMapData = L.geoJSON(geojsonFeature, {
    //     // style counties with initial default path options
    //     onEachFeature: function (feature, layer) {
    //       layer.bindPopup(`<b>Value:</b> ${feature.properties.value}</h3>`)
    //     },
    //     pointToLayer: function (feature, latlng) {
    //       return L.circleMarker(latlng, mapops)
    //     },
    //   }).addTo(map)


    function onMapClick() {

      //.button1 {background-color: #4CAF50};, try the button color, change the button color to provide some context that now mapping can occur, not just zooming on the map

      //Creating a location where all the newly created points on map click can be stored
      EnteredData = []
      //Now creating the popup, if I've also created a popup in the previous section when data are uploaded, maybe I should modify to refer to popup2 rather than both places calling popup
      function createPopup2(e) {

       
//         EnteredData.push = [ {
//       "type": "Feature",
//              "geometry": {
//               "type": "Point",
//               //first we collect the latitude, then the longitude, these are items 0 and 1 
//                "coordinates": [e.latlng.lng, e.latlng.lat]
//              },
//              "properties": {
//         //       //item 2 in the same row is the value, what we want to plot
//               "value": 0
//              }
//       }
// ]

        // Add marker to map at click location; add popup window
        //https://stackoverflow.com/questions/18388288/how-do-you-add-marker-to-map-using-leaflet-map-onclick-function-event-handl
        const infowindow = L.popup(e);

        EnteredData.push(L.circleMarker
          (e.latlng, {
            "opacity": 1,
            "weight": 2,
            "fillOpacity": 0.6,
            "color": 'green',
            "fillColor": 'green',
          } //close newMarker

          ).bindPopup(infowindow)
          .addTo(map)); //add the marker to the map

        //The console log for the EnteredData shows the array increasing
        console.log(EnteredData)

        //Show the total number of points added in the right panel to the user
        $(".TotalAdd").html((EnteredData.length).toLocaleString());

        //In the const save line, it looks to be calling for a popup and save id, like with the other buttons
        //So I added id=popup and id=save to the form text
      //  const save = document.querySelector('#popup2 #save')
        //I keep getting an error in the console, TypeError: save is null
      //  save.addEventListener('click', function () {
      //  const value = document.querySelector('#popup2 #fname').value
       // data = []
       // data.addData(
          //    {
          //      "type": "Feature",
          //      "geometry": {
          //      "type": "Point",
          //        "coordinates": [e.latlng.lng, e.latlng.lat]
          //      },
          //      "properties": {
          //        "value": value
          //      }
          //    }
          //  ) //end of data.addData

        infowindow
          .setLatLng(e.latlng)
          .setContent(
            //  //Now the single quote below this line
            `
    Location: ${e.latlng.toString()}<br>
      <form action="" id="popup2">
      <label for="fname">Value: </label>
      <input type="text" id="fname" name="fname"><br><br>
     <input type="submit" value="Save" id="save" name="save">
     <input type="submit" value="Delete" id="del">
      </form>
`
            //Note the single quote above this line
          )
//console.log(data)

     //    }) //end of save.addEventListener('click', function () 

        // //Now create the option for deleting the point
        // const del = document.querySelector('#popup #del')
        // del.addEventListener('click', function () {
        //   map.removeLayer(newMarker)
        // }) //end of del.addEventListener('click', function () {

      } //end of create popup, function createPopup(e) {

      //Now show the popup when the map is clicked
      map.on('click', createPopup2);

      //Creates the option for the generate map
      //  const genmap = document.querySelector('#genmap')

      //  genmap.addEventListener('click', function () {
      //    console.log(data)
      // draw new map and legend
      //     generateMap(data)
      //   })

    } //end of the onMapClick function


    //Here is the original merge attempt from Boyd's code
    // function onMapClick() {
    //   //.button1 {background-color: #4CAF50};, try the button color, change the button color to provide some context that now mapping can occur, not just zooming on the map

    //   //Creating a location where all the newly created points on map click can be stored
    //   EnteredData = []

    //   //Now creating the popup, if I've also created a popup in the previous section when data are uploaded, maybe I should modify to refer to popup2 rather than both places calling popup
    //   function createPopup2(e) {
    //     // Add marker to map at click location; add popup window
    //     //https://stackoverflow.com/questions/18388288/how-do-you-add-marker-to-map-using-leaflet-map-onclick-function-event-handl
    //     var newMarker = EnteredData.push(new L.circleMarker(e.latlng, {
    //         "opacity": 1,
    //         "weight": 2,
    //         "fillOpacity": 0.6,
    //         "color": 'green',
    //         "fillColor": 'green'
    //     } //close newMarker
    //     ).addTo(map)); //add the marker to the map

    //     //The console log for the NewMarker shows the number of points added
    //     console.log(newMarker)
    //     //The console log for the EnteredData shows the array increasing
    //     console.log(EnteredData)
    //     //Show the total number of points added in the right panel to the user
    //     $(".TotalAdd").html((EnteredData.length).toLocaleString());

    //     //In the const save line, it looks to be calling for a popup and save id, like with the other buttons
    //     //So I added id=popup and id=save to the form text
    //     const save = document.querySelector('#popup2 #save')
    //     //I keep getting an error in the console, TypeError: save is null
    //     save.addEventListener('click', function () {
    //       const value = document.querySelector('#popup2 #fname').value
    //       data.addData(
    //         {
    //           "type": "Feature",
    //           "geometry": {
    //             "type": "Point",
    //             "coordinates": [e.latlng.lng, e.latlng.lat]
    //           },
    //           "properties": {
    //             "value": value
    //           }
    //         }
    //       ) //end of data.addData

    //       //now we are creating the popup
    //       const popup2 = L.popup(e)
    //         .setLatLng(e.latlng)
    //         .setContent(
    //      //Now the single quote below this line
    //       `
    //         <form action="" id="popup2">
    //           Location: ${e.latlng.toString()}<br>
    //           <label for="fname">Value: ${value}</label>
    //           <input type="text" id="fname" name="fname"><br><br>
    //           <input type="submit" value="Save" id="save" name="save">
    //           <input type="submit" value="Delete" id="del">
    //         </form>
    //       `
    //       //Note the single quote above this line
    //         )
    //         .openOn(map);
    //       //console.log(data)

    //     }) //end of save.addEventListener('click', function () 

    //     //Now create the option for deleting the point
    //     const del = document.querySelector('#popup2 #del')
    //     del.addEventListener('click', function () {
    //       map.removeLayer(newMarker)
    //     }) //end of del.addEventListener('click', function () {

    //   } //end of create popup, function createPopup2(e) {

    //   //Now show the popup when the map is clicked
    //   map.on('click', createPopup2);

    //   //Creates the option for the generate map
    //   const genmap = document.querySelector('#genmap')

    //   genmap.addEventListener('click', function () {
    //     console.log(data)
    //     // draw new map and legend
    //   })

    // } //end of the onMapClick function






    //     var popup = L.popup();

    // //Here's a function that would pull up an information panel when the map is clicked
    // //A user could then enter data, though right now it's a static popup
    // //Some type of event handler, maybe a .onclick function?

    // function onMapClick(e) {
    //   popup
    //     .setLatLng(e.latlng)
    //     .setContent(
    //       "Location:" + e.latlng.toString() + `<br>` +
    //       `<form action="">
    //         <label for="fname">Value:</label>
    //         <input type="text" id="fname" name="fname"><br><br>
    //         <input type="submit" value="Save">
    //         <input type="submit" value="Delete">
    //       </form>`
    //     )
    //     .openOn(map);
    // }

    // map.on('click', onMapClick);









    //////////////////////////////END OF ADD POINTS FUNCTIONALITY

    //////////////////////////////NOW VISUALIZE THE USER ENTERED DATA
    ///This code will be similar to the code from the upload data options, but will use the EnteredData instead of NewMapData

    function generateMap(EnteredData) {
      document.getElementById("genmap").addEventListener("click", function () {
        console.log(EnteredData);
        var totalvalues = console.log(Object.keys(EnteredData).length + 1);
        getClassBreaks(EnteredData)

        function getClassBreaks(EnteredData) {
          // 				// create empty Array for storing values
          const alldata = [];
          // 				// loop through all the counties
          EnteredData.eachLayer(function (layer) {
            let values = layer.feature.properties.value;
            alldata.push(values); // push the normalized value for each layer into the Array
          });
          // 				// determine similar clusters
          const clusters = ss.ckmeans(alldata, 4);
          console.log(clusters)
          // 				// create an array of the lowest value within each cluster
          const breaks = clusters.map(function (cluster) {
            return [cluster[0], cluster.pop()];
          });
          // 				//return array of arrays, e.g., [[0.24,0.25], [0.26, 0.37], etc]
          return breaks;
        } //this is the end of the getClassBreaks function

        function getColor2(d, breaks) {
          // 				// function accepts a single normalized data attribute value
          // 				// and uses a series of conditional statements to determine which
          // 				// which color value to return to return to the function caller
          // 				// we defined breaks as a const, so it is a standard reference that can't be changed

          if (d <= breaks[0][1]) {
            return '#fef0d9';
          } else if (d <= breaks[1][1]) {
            return '#fdcc8a';
          } else if (d <= breaks[2][1]) {
            return '#fc8d59';
          } else if (d <= breaks[3][1]) {
            return '#d7301f'
          }
        } //this is the end of the getColor function

        const breaks = getClassBreaks(EnteredData);

        EnteredData.eachLayer(function (layer) {
          // console.log(breaks)
          console.log(layer.feature.properties.value[0]);
          layer.setStyle({
            fillColor: getColor2(layer.feature.properties.value[0], breaks),
            fillOpacity: 1
            // fillColor: getColor2(breaks)
          })
        });

        //zoom out slightly to make space for the legend
        map.setZoom(map.getZoom() - .8);

        // Setting up the legend
        var legend = L.control({ position: 'bottomleft' });

        legend.onAdd = function (map) {
          var div = L.DomUtil.create('div', 'info legend'),
            grades = [0, 25, 50, 75, 100],
            labels = [];

          div.innerHTML += `<span class='TotalVar'></span>` + `<b>Look! A legend!</b><span class='TotalVar'></span><br><br>`
          div.innerHTML += `There are how many items plotted?`
          //  for (var i = 0; i < grades.length; i++) {
          //  div.innerHTML +=
          //      '<i style="background:' + getColorANC(grades[i] + 1) + '"></i> ' +
          //      grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '%');
          // } //this closes the for
          return div;

          //          for (let i = 0; i <= breaks.length - 1; i++) {
          //					let color = getColor2(breaks[i][0], breaks);
          //					legend.append(
          //						`<span style="background:${color}"></span>
          //					<label>${(breaks[i][0] * 100).toLocaleString()} &mdash;
          //					${(breaks[i][1] * 100).toLocaleString()}%</label>`);
          //				}

        }; //closes the legend.onAdd function


        legend.addTo(map); //add the legend to the map

      }) //closes the button portion
    } //end of updateLegend function

    //////////////////////////////END OF BUTTON FUNCTIONALITY: MAPIT - USER INPUT


/////////////////////////////////////////////////////////////////////////
//END OF CODE FOR USER CLICKING ON MAP, CREATING POINTS, AND VISUALIZING//
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////








    //////////////////////////////TEST CODE FOR GETTING PDF OF THE MAP

    // https://gis.stackexchange.com/questions/238414/adding-a-new-and-removing-an-old-marker-every-time-the-user-click-on-the-map
    //https://www.codementor.io/@amehjoseph/convert-html-css-content-to-a-sleek-multiple-page-pdf-file-using-jspdf-javascript-library-eyyz74hci

    //This code is from the following page
    //https://gist.github.com/ka7eh/88761650efd3425080035e8535230d15
  //  document.getElementById("printit").onclick = downloadMap;

    //   function downloadMap(err, canvas) {
    //     var imgData = canvas.toDataURL("image/svg+xml", 1.0);
    //     var dimensions = map.getSize();

    //     var pdf = new jsPDF('l', 'pt', 'letter');
    //     pdf.addImage(imgData, 'PNG', 10, 10, dimensions.x * 0.5, dimensions.y * 0.5);

    //     cover.className = '';

    //     pdf.save("download.pdf");
    //    };

    //https://github.com/mapbox/leaflet-image
  //  function downloadMap() {

 //     leafletImage(map, function (err, canvas) {
        // now you have canvas
        // example thing to do with that canvas:
   //     var img = document.createElement('img');
  //      var dimensions = map.getSize();
   //     img.width = dimensions.x;
   //     img.height = dimensions.y;
   //     img.src = canvas.toDataURL();
        // document.getElementById('images').innerHTML = '';
        // document.getElementById('images').appendChild(img);
  //    });
  //  }

    //////////////////////////////TEST CODE FOR GETTING PDF OF THE MAP


    ////////////////////////////////////////////MOUSEOVER EVENTS TO ADD IN
//    function mouseEvents(geojsonFeature) {
 //     console.log(geojsonFeature[1].properties.value[0])
 //     for (var i = 0; i < geojsonFeature.length; i++) {

//        geojsonFeature.on("mouseover", function (e) {
//          this.openPopup(); //can put the popup here
//          this.setStyle(
//            {
//              color: 'red',
//            }
///          )
 //       });


  //      geojsonFeature.on("mouseout", function (e) {
  //        this.closePopup(); //can put the popup here
  //        this.setStyle(
  ///          {
  //            color: 'black',
  //          }
  ////        )
  //      });
  //    } //end of the for loop
  //    bindPopup(popup); //myFunction(ValueLayer)
  //  }
////////////////////////////////////////////END OF MOUSEOVER EVENTS TO ADD IN

 ///https://eloquentjavascript.net/15_event.html

  </script>
</body>

</html>